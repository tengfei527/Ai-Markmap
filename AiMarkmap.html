<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<!-- <meta name="viewport" content="width=device-width, initial-scale=1.0" /> -->
<title>AIæ€ç»´å¯¼å›¾ç”Ÿæˆå™¨ - Markmap</title>
<script src="https://unpkg.com/d3@7.8.5/dist/d3.min.js"></script>
<script src="https://unpkg.com/markmap-lib@0.15.3/dist/browser/index.js"></script>
<script src="https://unpkg.com/markmap-view@0.15.3/dist/browser/index.js"></script>
<script src="https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<style>
    * { margin: 0; padding: 0; box-sizing: border-box; } body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; } 
    .header { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); padding: 0.5rem 2rem; border-bottom: 1px solid rgba(255, 255, 255, 0.2); display: flex; align-items: center; justify-content: space-between; } 
    .header h1 { color: white; font-size: 1.8rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; } .ai-badge { background: linear-gradient(45deg, #ff6b6b, #ffa500); padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.8rem; font-weight: 500; color: white; animation: pulse 2s infinite; } @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } } 
    .lang-switcher { display: flex; align-items: center; gap: 0.5rem; }
    .lang-btn { background: rgba(255, 255, 255, 0.2); border: 1px solid rgba(255, 255, 255, 0.3); color: white; padding: 0.4rem 0.8rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 500; transition: all 0.2s; }
    .lang-btn:hover { background: rgba(255, 255, 255, 0.4); }
    .lang-btn.active { background: white; color: #667eea; font-weight: 600; border-color: white; }
    .container { display: flex; height: calc(100vh - 68px); gap: 1rem; padding: 1rem; flex-wrap: nowrap; } 
    .editor-panel { width: 400px; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); flex-shrink: 0; height: 100%; } .panel-header { background: rgba(102, 126, 234, 0.1); padding: 0.5rem 1rem; border-bottom: 1px solid rgba(102, 126, 234, 0.2); flex-shrink: 0; } .panel-title { font-size: 1rem; font-weight: 600; color: #4c63d2; margin-bottom: 0.25rem; display: flex; align-items: center; gap: 0.5rem; } .ai-config { background: rgba(255, 255, 255, 0.8); padding: 0.75rem; border-bottom: 1px solid #e0e0e0; flex-shrink: 0; } .config-row { display: flex; gap: 0.5rem; margin-bottom: 0.4rem; align-items: center; } .config-label { font-size: 0.8rem; color: #666; min-width: 50px; flex-shrink: 0; padding-top: 0; } .config-input { flex: 1; padding: 0.4rem 0.6rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.85rem; min-width: 120px; height: 32px; } .model-input-wrapper { flex: 1; display: flex; flex-direction: column; } .hidden { display: none !important; } #custom-model-input { margin-top: 0.4rem; } .model-container { display: flex; gap: 0.3rem; align-items: center; width: 100%; } .model-select { flex: 1; padding: 0.4rem 0.6rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.85rem; height: 32px; background: white; cursor: pointer; } .query-models-btn { padding: 0.3rem 0.6rem; border: 1px solid #667eea; border-radius: 4px; background: linear-gradient(135deg, #e3f2fd, #f3e5f5); color: #4c63d2; cursor: pointer; font-size: 0.75rem; transition: all 0.2s; white-space: nowrap; height: 32px; display: flex; align-items: center; justify-content: center; min-width: 60px; } .query-models-btn:hover { background: linear-gradient(135deg, #bbdefb, #e1bee7); transform: translateY(-1px); box-shadow: 0 3px 8px rgba(102, 126, 234, 0.2); } .query-models-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; box-shadow: none !important; } .button-row { display: flex; gap: 0.4rem; margin-bottom: 0.6rem; } .control-btn { padding: 0.5rem 0.8rem; border: none; border-radius: 5px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s; flex: 1; min-width: 70px; font-weight: 500; height: 34px; display: flex; align-items: center; justify-content: center; } .control-btn.ai-btn { background: linear-gradient(45deg, #667eea, #764ba2); color: white; border: 2px solid transparent; } .control-btn.ai-btn:hover { background: linear-gradient(45deg, #5a67d8, #6b46c1); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); } .control-btn.view-btn { background: linear-gradient(135deg, #e3f2fd, #f3e5f5); color: #4c63d2; border: 1px solid #667eea; } .control-btn.view-btn:hover { background: linear-gradient(135deg, #bbdefb, #e1bee7); transform: translateY(-1px); box-shadow: 0 3px 8px rgba(102, 126, 234, 0.2); } .control-btn.view-btn.active { background: linear-gradient(45deg, #667eea, #764ba2); color: white; border: 1px solid #667eea; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4); } .control-btn.markdown-btn { background: linear-gradient(135deg, #e8f5e8, #f0f8ff); color: #2e7d32; border: 1px solid #4caf50; } .control-btn.markdown-btn:hover { background: linear-gradient(135deg, #c8e6c9, #e3f2fd); transform: translateY(-1px); box-shadow: 0 3px 8px rgba(76, 175, 80, 0.2); } .control-btn.markdown-btn.active { background: linear-gradient(45deg, #4caf50, #2e7d32); color: white; border: 1px solid #4caf50; box-shadow: 0 2px 8px rgba(76, 175, 80, 0.4); } .control-btn.clear-btn { background: linear-gradient(135deg, #ffebee, #fce4ec); color: #d32f2f; border: 1px solid #f44336; flex: 0 0 auto; min-width: 55px; } .control-btn.clear-btn:hover { background: linear-gradient(135deg, #ffcdd2, #f8bbd9); transform: translateY(-1px); box-shadow: 0 3px 8px rgba(244, 67, 54, 0.2); } .control-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; box-shadow: none !important; } .input-section { flex: 1; display: flex; flex-direction: column; padding: 0.75rem; overflow: hidden; } .text-input, .content-display { width: 100%; flex: 1; padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem; resize: none; line-height: 1.5; background: #fafafa; min-height: 200px; } .mindmap-panel { flex: 1; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); position: relative; display: flex; flex-direction: column; height: 100%; } 
    .mindmap-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 0.5rem 1rem; display: flex; justify-content: space-between; align-items: center; gap: 0.5rem; } .export-btn { background: rgba(255, 255, 255, 0.2); color: white; border: 1px solid rgba(255, 255, 255, 0.3); padding: 0.4rem 1rem; border-radius: 6px; cursor: pointer; transition: all 0.2s; min-width: 80px; font-weight: 500; } .export-btn:hover { background: rgba(255, 255, 255, 0.3); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); } .export-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; box-shadow: none !important; } 
    .results-tabs { display: flex; gap: 0.5rem; }
    .result-tab-btn { background: rgba(255, 255, 255, 0.2); color: white; border: 1px solid rgba(255, 255, 255, 0.3); padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; transition: all 0.2s; font-weight: 500; }
    .result-tab-btn:hover { background: rgba(255, 255, 255, 0.3); }
    .result-tab-btn.active { background: rgba(255, 255, 255, 0.4); font-weight: 700; border-color: white; }
    .mindmap-container { width: 100%; height: calc(100% - 52px); background: white; position: relative; flex: 1; } #mindmap { width: 100%; height: 100%; }
    .loading-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; color: #666; gap: 0.5rem; }
    .spinner-container { position: relative; width: 60px; height: 60px; margin-bottom: 0.5rem; }
    .loading-spinner { width: 60px; height: 60px; border: 5px solid #f3f3f3; border-top: 5px solid #4c63d2; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    #timer-display { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: 600; color: #5a67d8; font-size: 1rem; }
    .status-message { font-size: 0.9rem; text-align: center; }

    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 2000; backdrop-filter: blur(5px); opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
    .modal-overlay:not(.hidden) { opacity: 1; visibility: visible; }
    .modal-content { background: #fdfdff; border-radius: 12px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2); width: 450px; overflow: hidden; position: relative; transform: scale(0.95); transition: transform 0.3s ease; }
    .modal-overlay:not(.hidden) .modal-content { transform: scale(1); }
    .modal-close-btn { position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 1.8rem; color: #999; cursor: pointer; line-height: 1; padding: 0; }
    .modal-close-btn:hover { color: #333; }
    .modal-content .ai-config { padding: 1rem 1.5rem 1.5rem 1.5rem; background: transparent; border-bottom: none; }
    .modal-content .panel-header { background: rgba(102, 126, 234, 0.1); padding: 1rem 1.5rem; }
    .panel-section { padding: 0.75rem; background: rgba(255, 255, 255, 0.8); border-bottom: 1px solid #e0e0e0; }
    .panel-section .config-row { margin-bottom: 0 !important; }
    .panel-section .button-row:last-child { margin-bottom: 0; }
    .editor-panel > .panel-header { display: flex; justify-content: space-between; align-items: center; }
    
    #settings-btn, #prompt-settings-btn {
        flex: 0 0 auto;
        padding: 0.4rem 0.8rem;
        height: 30px;
        background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
        color: #4c63d2;
        border: 1px solid #667eea;
    }
    #settings-btn:hover, #prompt-settings-btn:hover {
        background: linear-gradient(135deg, #bbdefb, #e1bee7);
        transform: translateY(-1px);
        box-shadow: 0 3px 8px rgba(102, 126, 234, 0.2);
    }
    
    .prompt-tip {
        background-color: #e3f2fd;
        border: 1px solid #90caf9;
        color: #1e88e5;
        padding: 0.75rem 1rem;
        border-radius: 6px;
        font-size: 0.85rem;
        margin-bottom: 1rem;
        line-height: 1.4;
    }
    .prompt-tip code {
        background-color: rgba(255, 255, 255, 0.7);
        padding: 0.1em 0.4em;
        border-radius: 4px;
        font-weight: 600;
        color: #d32f2f;
    }
    
    #version-slider {
        flex: 1;
        -webkit-appearance: none;
        appearance: none;
        height: 8px;
        background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
        border-radius: 5px;
        outline: none;
        cursor: pointer;
        border: 1px solid rgba(102, 126, 234, 0.2);
        transition: opacity .2s;
    }

    #version-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        background: #fff;
        border-radius: 50%;
        cursor: pointer;
        border: 3px solid #8b9bed;
        box-shadow: 0 2px 5px rgba(102, 126, 234, 0.2);
        margin-top: -7px;
        transition: all 0.2s ease;
    }

    #version-slider:hover::-webkit-slider-thumb {
        transform: scale(1.15);
        background: #667eea;
        border-color: #667eea;
        box-shadow: 0 3px 8px rgba(102, 126, 234, 0.35);
    }

    #version-slider::-moz-range-thumb {
        width: 20px;
        height: 20px;
        background: #fff;
        border-radius: 50%;
        cursor: pointer;
        border: 3px solid #8b9bed;
        box-shadow: 0 2px 5px rgba(102, 126, 234, 0.2);
        transition: all 0.2s ease;
    }

    #version-slider:hover::-moz-range-thumb {
        transform: scale(1.15);
        background: #667eea;
        border-color: #667eea;
        box-shadow: 0 3px 8px rgba(102, 126, 234, 0.35);
    }

    #version-count-display { font-weight: 600; color: #4c63d2; min-width: 20px; text-align: center; }
    .password-input-wrapper {
        position: relative;
        flex: 1;
        display: flex;
        align-items: center;
    }
    .password-input-wrapper .config-input {
        padding-right: 40px;
    }
    .visibility-toggle-btn {
        position: absolute;
        right: 0;
        top: 0;
        height: 100%;
        width: 40px;
        background: transparent;
        border: none;
        cursor: pointer;
        font-size: 1.1rem;
        color: #888;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: color 0.2s;
    }
    .visibility-toggle-btn:hover {
        color: #333;
    }
    .mindmap-header .panel-title { color: white; }
</style>
</head>
<body>
<div class="header">
    <h1>AiMarkmap <span class="ai-badge">AI Powered</span></h1>
    <div id="lang-switcher">
        <button data-lang="zh" class="lang-btn">ä¸­æ–‡</button>
        <button data-lang="en" class="lang-btn">EN</button>
    </div>
</div>
<div class="container">
    <div class="editor-panel">
        <div class="panel-header">
            <button class="control-btn" id="prompt-settings-btn" data-t="promptSettingsBtn"></button>
            <button class="control-btn" id="settings-btn" onclick="openSettingsModal()" data-t="apiSettingsBtn"></button>
        </div>
        <div class="panel-section">
             <div class="config-row">
                <span class="config-label" data-t="modelLabel"></span>
                <div class="model-input-wrapper">
                    <div class="model-container">
                        <select id="model-select" class="model-select">
                            <option value="custom">è‡ªå®šä¹‰</option>
                            <option value="gpt-4o-mini" selected>gpt-4o-mini</option>
                        </select>
                        <button class="query-models-btn" id="query-models-btn" onclick="queryAvailableModels()" data-t="queryBtn"></button>
                    </div>
                    <input type="text" id="custom-model-input" class="config-input hidden" data-t-placeholder="customModelInputPlaceholder">
                </div>
            </div>
        </div>
        <div class="panel-section">
            <div class="config-row">
                <span class="config-label" data-t="versionsLabel"></span>
                <input type="range" id="version-slider" min="1" max="5" value="3">
                <span id="version-count-display">3</span>
            </div>
        </div>
        <div class="panel-section">
            <div class="button-row">
                <button class="control-btn ai-btn" id="generate-btn" onclick="generateWithAI()" data-t="generateBtn"></button>
                <button class="control-btn ai-btn" id="paste-generate-btn" onclick="pasteAndGenerate()" data-t="pasteGenerateBtn"></button>
            </div>
            <div class="button-row">
                <button class="control-btn view-btn" id="show-original-btn" onclick="switchView('original')" data-t="showOriginalBtn"></button>
                <button class="control-btn markdown-btn" id="show-markdown-btn" onclick="switchView('markdown')" data-t="showMarkdownBtn"></button>
                <button class="control-btn clear-btn" id="clear-btn" onclick="clearContent()" data-t="clearBtn"></button>
            </div>
        </div>
        <div class="input-section">
            <textarea id="topic-input" class="text-input" data-t-placeholder="topicInputPlaceholder"></textarea>
            <textarea id="content-display" class="content-display" style="display: none;" data-t-placeholder="contentDisplayPlaceholder"></textarea>
        </div>
    </div>
    <div class="mindmap-panel">
        <div class="mindmap-header">
            <div class="panel-title" data-t="mindmapPreviewTitle"></div>
            <div id="results-tabs" class="results-tabs"></div>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <button id="fullscreen-btn" class="export-btn" onclick="toggleFullScreen()"></button>
                <button class="export-btn" id="export-btn" onclick="exportPNG()" data-t="exportBtn" disabled></button>
            </div>
        </div>
        <div class="mindmap-container" id="mindmap-container">
            <svg id="mindmap"></svg>
            <div id="loading-overlay" class="loading-overlay" style="display: none;">
                <div class="spinner-container">
                    <div class="loading-spinner"></div>
                    <span id="timer-display"></span>
                </div>
                <div data-t="thinkingMessage"></div>
                <div class="status-message" id="status-message"></div>
            </div>
        </div>
    </div>
</div>

<div id="settings-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <button class="modal-close-btn" onclick="closeSettingsModal()">&times;</button>
        <div class="panel-header">
            <div class="panel-title" data-t="apiSettingsTitle"></div>
        </div>
        <div class="ai-config">
            <div class="config-row">
                <span class="config-label" data-t="apiUrlLabel"></span>
                <input type="text" id="api-url" class="config-input" data-t-placeholder="apiUrlPlaceholder" />
            </div>
            <div class="config-row">
                <span class="config-label" data-t="apiKeyLabel"></span>
                <div class="password-input-wrapper">
                    <input type="password" id="api-key" class="config-input" data-t-placeholder="apiKeyPlaceholder" />
                    <button type="button" id="toggle-api-key-visibility" class="visibility-toggle-btn" data-t-title="toggleVisibilityTitle">ğŸ‘ï¸</button>
                </div>
            </div>
            <div class="button-row">
                <button class="control-btn ai-btn" onclick="saveAndCloseSettings()" data-t="saveAndCloseBtn"></button>
            </div>
        </div>
    </div>
</div>

<div id="prompt-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <button class="modal-close-btn" onclick="closePromptModal()">&times;</button>
        <div class="panel-header">
            <div class="panel-title" data-t="promptSettingsTitle"></div>
        </div>
        <div class="ai-config">
            <div class="prompt-tip" data-t="promptTip"></div>
            <textarea id="prompt-input" class="text-input" style="height: 350px; min-height: 200px; margin-bottom: 1rem;" data-t-placeholder="promptInputPlaceholder"></textarea>
            <div class="button-row">
                <button class="control-btn ai-btn" onclick="saveAndClosePrompt()" data-t="saveAndCloseBtn"></button>
            </div>
        </div>
    </div>
</div>

<script>
let mm = null;
let transformer = null;
let debounceTimer = null;
let currentMarkdown = '';
let aiResults = [];
let activeResultIndex = -1;
let timerInterval = null;
let startTime = 0;
let currentViewMode = 'input';
let AI_PROMPT_TEMPLATE = '';

// === Language Switching Start ===
let currentLanguage = 'zh';

const translations = {
    zh: {
        // --- UI Elements ---
        'promptSettingsBtn': 'ğŸ“ Promptè®¾ç½®',
        'apiSettingsBtn': 'âš™ï¸ APIè®¾ç½®',
        'modelLabel': 'æ¨¡å‹:',
        'queryBtn': 'ğŸ” æŸ¥è¯¢',
        'versionsLabel': 'ç‰ˆæœ¬æ•°é‡:',
        'generateBtn': 'ğŸš€ AIç”Ÿæˆ',
        'pasteGenerateBtn': 'ğŸ“‹ ç²˜è´´å¹¶ç”Ÿæˆ',
        'showOriginalBtn': 'ğŸ“„ æ˜¾ç¤ºåŸæ–‡',
        'showMarkdownBtn': 'ğŸ“ æ˜¾ç¤ºMarkdown',
        'clearBtn': 'ğŸ—‘ï¸ æ¸…ç©º',
        'fullscreenBtn': 'å…¨å±æ˜¾ç¤º(F11)',
        'exportBtn': 'å¯¼å‡º PNG',
        'mindmapPreviewTitle': 'ğŸ§  æ€ç»´å¯¼å›¾é¢„è§ˆ',
        'thinkingMessage': 'AIæ­£åœ¨æ€è€ƒä¸­...',
        'apiSettingsTitle': 'âš™ï¸ API è®¾ç½®',
        'apiUrlLabel': 'APIåœ°å€:',
        'apiKeyLabel': 'APIç§˜é’¥:',
        'saveAndCloseBtn': 'ğŸ’¾ ä¿å­˜å¹¶å…³é—­',
        'promptSettingsTitle': 'ğŸ“ Prompt è®¾ç½®',
        'promptTip': 'è¯·ç¡®ä¿åœ¨Promptæ¨¡æ¿ä¸­åŒ…å« <code>{{CONTENT}}</code>ï¼Œå®ƒå°†è¢«æ›¿æ¢ä¸ºå·¦ä¾§çš„è¾“å…¥å†…å®¹ã€‚',
        
        // --- Placeholders & Titles ---
        'customModelInputPlaceholder': 'è¾“å…¥è‡ªå®šä¹‰æ¨¡å‹åç§°',
        'topicInputPlaceholder': 'å¯ç›´æ¥è¾“å…¥æˆ–ç²˜è´´Markdownï¼Œæˆ–è¾“å…¥æ™®é€šæ–‡æœ¬åç‚¹å‡»â€œAIç”Ÿæˆâ€...',
        'contentDisplayPlaceholder': 'ç¼–è¾‘å†…å®¹...',
        'apiUrlPlaceholder': 'AI APIåœ°å€',
        'apiKeyPlaceholder': 'APIå¯†é’¥',
        'toggleVisibilityTitle': 'æ˜¾ç¤º/éšè—å¯†é’¥',
        'promptInputPlaceholder': 'åœ¨æ­¤ç¼–è¾‘AI Promptæ¨¡æ¿...',

        // --- Dynamic JS Strings ---
        'js_generating': 'ç”Ÿæˆä¸­...',
        'js_exporting': 'å¯¼å‡ºä¸­...',
        'js_querying': 'æŸ¥è¯¢ä¸­...',
        'js_exit_fullscreen': 'é€€å‡ºå…¨å±(F11)',
        'js_fullscreen': 'å…¨å±æ˜¾ç¤º(F11)',
        'js_status_requesting': 'æ­£åœ¨å‘èµ·AIè¯·æ±‚...',
        'js_status_generated': (s, n) => `å·²æˆåŠŸç”Ÿæˆ ${s}/${n} ä¸ªç‰ˆæœ¬...`,
        'js_status_done': (n) => `ç”Ÿæˆå®Œæˆï¼å…± ${n} ä¸ªæœ‰æ•ˆç‰ˆæœ¬ã€‚`,
        'js_tab_version': (i) => `ç‰ˆæœ¬ ${i + 1}`,
        'js_alert_no_content': 'è¯·å…ˆè¾“å…¥å†…å®¹ï¼',
        'js_alert_no_api_config': 'è¯·å…ˆç‚¹å‡»å³ä¸Šè§’â€œAPIè®¾ç½®â€é…ç½®APIåœ°å€å’Œå¯†é’¥ï¼',
        'js_alert_no_custom_model': 'è¯·åœ¨è‡ªå®šä¹‰è¾“å…¥æ¡†ä¸­å¡«å†™æ¨¡å‹åç§°ï¼',
        'js_alert_all_failed': 'æ‰€æœ‰AIç”Ÿæˆè¯·æ±‚å‡å¤±è´¥æˆ–è¿”å›ç©ºå†…å®¹ã€‚è¯·æ£€æŸ¥APIè®¾ç½®å’Œç½‘ç»œã€‚',
        'js_alert_gen_failed': (msg) => `AIç”Ÿæˆå¤±è´¥: ${msg}`,
        'js_alert_no_clipboard': 'æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒå‰ªè´´æ¿ APIï¼Œè¯·æ‰‹åŠ¨ç²˜è´´å†…å®¹ã€‚',
        'js_alert_clipboard_empty': 'å‰ªè´´æ¿å†…å®¹ä¸ºç©ºã€‚',
        'js_alert_clipboard_error': 'æ— æ³•è¯»å–å‰ªè´´æ¿å†…å®¹ã€‚\nè¯·ç¡®ä¿é¡µé¢å¤„äºæ¿€æ´»çŠ¶æ€ï¼Œå¹¶å·²æˆäºˆæµè§ˆå™¨è¯»å–å‰ªè´´æ¿çš„æƒé™ã€‚',
        'js_alert_query_no_config': 'è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®APIåœ°å€å’Œå¯†é’¥ï¼',
        'js_alert_query_failed': (msg) => `æŸ¥è¯¢æ¨¡å‹å¤±è´¥: ${msg}`,
        'js_alert_query_success': (n) => `æˆåŠŸè·å–åˆ° ${n} ä¸ªå¯ç”¨æ¨¡å‹ï¼`,
        'js_alert_no_mindmap': 'æ‰¾ä¸åˆ°æ€ç»´å¯¼å›¾ï¼Œæ— æ³•å¯¼å‡ºã€‚',
        'js_alert_export_error': 'å¯¼å‡ºPNGå›¾ç‰‡æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•ã€‚',
        
        // --- Content ---
        'defaultMarkdown': `# ğŸ¤– AIæ€ç»´å¯¼å›¾ç”Ÿæˆå™¨

## âœ¨ æ–°åŠŸèƒ½ç‰¹æ€§
### ğŸ¯ æ™ºèƒ½ç”Ÿæˆ
- âœ¨ **è‡ªå®šä¹‰ç”Ÿæˆç‰ˆæœ¬æ•°é‡ (1-5)**
- AIé©±åŠ¨çš„å†…å®¹åˆ›å»º
### ğŸ”§ è‡ªå®šä¹‰é…ç½®
- ä¾¿æ·çš„æ¨¡å‹é€‰æ‹©
- å¼¹çª—é…ç½®APIå¯†é’¥
- ä¸ªæ€§åŒ–è®¾ç½®

## ğŸš€ ä½¿ç”¨æµç¨‹
### ğŸ“ è¾“å…¥å†…å®¹
- åœ¨å·¦ä¾§è¾“å…¥æ¡†æè¿°å†…å®¹
- æˆ–ç›´æ¥ç²˜è´´Markdown
### ğŸ¤– AIå¤„ç†
- **æ‹–åŠ¨æ»‘å—é€‰æ‹©ç‰ˆæœ¬æ•°**
- ç‚¹å‡»ç”ŸæˆæŒ‰é’®
### ğŸ¨ å¯è§†åŒ–å±•ç¤º
- **ç‚¹å‡»é€‰é¡¹å¡åˆ‡æ¢ä¸åŒç‰ˆæœ¬**
- å®æ—¶é¢„è§ˆæ€ç»´å¯¼å›¾
- ä¸€é”®å¯¼å‡ºPNGå›¾ç‰‡`,
        'defaultPrompt': `ä½ æ˜¯ä¿¡æ¯æ¶æ„ä¸“å®¶ï¼Œæ“…é•¿æå–ä¿¡æ¯çš„ç»“æ„ä¸å±‚æ¬¡å…³ç³»ã€‚è¯·å°†ä»¥ä¸‹å†…å®¹ä»¥æ€ç»´å¯¼å›¾çš„Markdownæ ¼å¼è¾“å‡ºï¼š"{{CONTENT}}"ã€‚

è¯·éµå¾ªä»¥ä¸‹è¦æ±‚ï¼š

1.  å†…å®¹åˆ†æï¼š
   - è¯·æ ¹æ®å†…å®¹æœ¬èº«çš„é€»è¾‘ç»“æ„ï¼Œå°½å¯èƒ½ç»†åŒ–å±‚çº§ï¼Œåˆ†æ¡å±•å¼€ã€‚

2. ç»“æ„è¦æ±‚ï¼š
   - ä¿æŒç»“æ„æ¸…æ™°ï¼Œæ–¹ä¾¿é˜…è¯»å’Œè§£æ
   - å±‚çº§æ¸…æ™°ï¼Œç”¨#ã€##ã€###ç­‰è¡¨ç¤ºä¸åŒå±‚çº§ï¼Œä¾æ­¤ç±»æ¨ã€‚
   - å„èŠ‚ç‚¹ä½¿ç”¨åŸæ–‡æœ¬è¯­è¨€ã€‚
   - å†…å®¹ä¸­çš„æ¡ç›®è¯·ä½¿ç”¨åˆ—è¡¨å½¢å¼å‘ˆç°ã€‚
   - ä¸­å¿ƒä¸»é¢˜å­—æ•°æ§åˆ¶åœ¨10ä¸ªå­—å·¦å³ã€‚
   - å±‚çº§æ•°é‡æœ€å°‘3çº§ï¼Œæœ€å¤šä¸é™åˆ¶ã€‚
   - è‹¥å±‚çº§æˆ–åˆ†æ”¯çš„å†…å®¹å­—æ•°è¿‡å¤šï¼Œè¯·å°†å†…å®¹æ‹†åˆ†åŒå±‚çº§åˆ—å‡ºæˆ–ç»§ç»­å‘ä¸‹åˆ†å±‚ï¼Œä½¿ç»“æ„æ¸…æ™°ç®€æ´ã€‚
 

3.  å†…å®¹å¤„ç†ï¼š
   - ä¿ç•™åŸæ–‡å¥å­ã€‚
   - ä¸è¦æ·»åŠ è§£é‡Šæˆ–é¢å¤–è¯´æ˜ã€‚
   - ä¸è¦æ·»åŠ ä½ è‡ªå·±çš„è§‚ç‚¹æˆ–æ–‡ç« ä¹‹å¤–çš„ä¿¡æ¯ã€‚
   - å¯é€‚å½“åšå¥å¼å¾®è°ƒï¼Œä»¥æå‡è¡¨è¾¾æ¸…æ™°åº¦ã€‚
   - å¯é€‚å½“åˆ†ç‚¹åˆ—å‡ºé•¿å¥æˆ–å¤æ‚å†…å®¹ã€‚

4.  å¢å¼ºå¯è§†æ€§ï¼š
   - å°½é‡ä½¿ç”¨ Emoji è¡¨æƒ…å¢å¼ºå¯è¯»æ€§ã€‚

5.  è¾“å‡ºè¯­è¨€ï¼š
   - å¦‚æœåŸæ–‡æœ¬çš„ä¸»è¦å†…å®¹ä¸ºéä¸­æ–‡ï¼Œåˆ™å°†Markdownçš„æ‰€æœ‰å†…å®¹æŒ‰ç…§åŸæ–‡æœ¬çš„è¯­è¨€è¾“å‡ºã€‚

6.  è¾“å‡ºæ ¼å¼ï¼š
   - æœ€ç»ˆè¾“å‡ºä¸ºçº¯Markdownæ ¼å¼ã€‚
   - åªè¾“å‡º Markdown æ–‡æœ¬æœ¬ä½“ã€‚
   - ä¸è¦ä½¿ç”¨ä»£ç å—åŒ…è£¹ã€‚`
    },
    en: {
        'promptSettingsBtn': 'ğŸ“ Prompt Settings',
        'apiSettingsBtn': 'âš™ï¸ API Settings',
        'modelLabel': 'Model:',
        'queryBtn': 'ğŸ” Query',
        'versionsLabel': 'Versions:',
        'generateBtn': 'ğŸš€ AI Generate',
        'pasteGenerateBtn': 'ğŸ“‹ Paste & Generate',
        'showOriginalBtn': 'ğŸ“„ Show Original',
        'showMarkdownBtn': 'ğŸ“ Show Markdown',
        'clearBtn': 'ğŸ—‘ï¸ Clear',
        'fullscreenBtn': 'Fullscreen (F11)',
        'exportBtn': 'Export PNG',
        'mindmapPreviewTitle': 'ğŸ§  Mind Map Preview',
        'thinkingMessage': 'AI is thinking...',
        'apiSettingsTitle': 'âš™ï¸ API Settings',
        'apiUrlLabel': 'API URL:',
        'apiKeyLabel': 'API Key:',
        'saveAndCloseBtn': 'ğŸ’¾ Save & Close',
        'promptSettingsTitle': 'ğŸ“ Prompt Settings',
        'promptTip': 'Please make sure to include <code>{{CONTENT}}</code> in the prompt template, which will be replaced with the input content from the left.',
        
        'customModelInputPlaceholder': 'Enter custom model name',
        'topicInputPlaceholder': 'Enter or paste Markdown directly, or input text and click "AI Generate"...',
        'contentDisplayPlaceholder': 'Edit content...',
        'apiUrlPlaceholder': 'AI API Address',
        'apiKeyPlaceholder': 'API Key',
        'toggleVisibilityTitle': 'Show/Hide Key',
        'promptInputPlaceholder': 'Edit AI Prompt template here...',

        'js_generating': 'Generating...',
        'js_exporting': 'Exporting...',
        'js_querying': 'Querying...',
        'js_exit_fullscreen': 'Exit Fullscreen (F11)',
        'js_fullscreen': 'Fullscreen (F11)',
        'js_status_requesting': 'Initiating AI request...',
        'js_status_generated': (s, n) => `Successfully generated ${s}/${n} versions...`,
        'js_status_done': (n) => `Generation complete! ${n} valid versions available.`,
        'js_tab_version': (i) => `Version ${i + 1}`,
        'js_alert_no_content': 'Please enter content first!',
        'js_alert_no_api_config': 'Please configure API URL and Key in "API Settings" first!',
        'js_alert_no_custom_model': 'Please enter a model name in the custom input field!',
        'js_alert_all_failed': 'All AI generation requests failed or returned empty content. Please check API settings and network.',
        'js_alert_gen_failed': (msg) => `AI generation failed: ${msg}`,
        'js_alert_no_clipboard': "Your browser does not support the Clipboard API. Please paste the content manually.",
        'js_alert_clipboard_empty': 'Clipboard is empty.',
        'js_alert_clipboard_error': 'Could not read from clipboard.\nPlease ensure the page is active and has permission to read the clipboard.',
        'js_alert_query_no_config': 'Please configure API URL and Key in settings first!',
        'js_alert_query_failed': (msg) => `Query models failed: ${msg}`,
        'js_alert_query_success': (n) => `Successfully fetched ${n} available models!`,
        'js_alert_no_mindmap': 'Could not find the mind map to export.',
        'js_alert_export_error': 'An error occurred while exporting the PNG image. Please try again later.',
        
        'defaultMarkdown': `# ğŸ¤– AI Mind Map Generator

## âœ¨ Features
### ğŸ¯ Smart Generation
- âœ¨ **Custom number of versions (1-5)**
- AI-driven content creation
### ğŸ”§ Custom Configuration
- Easy model selection
- API key configuration via modal
- Personalized settings

## ğŸš€ How to Use
### ğŸ“ Input Content
- Describe content in the left input box
- Or paste Markdown directly
### ğŸ¤– AI Processing
- **Use the slider to select version count**
- Click the generate button
### ğŸ¨ Visualization
- **Click tabs to switch between versions**
- Real-time mind map preview
- One-click PNG export`,
        'defaultPrompt': `You are an expert in information architecture, skilled at extracting the structure and hierarchy of information. Please output the following content in Markdown format for a mind map: "{{CONTENT}}".

Please adhere to the following requirements:

1.  Content Analysis:
    - Analyze the inherent logical structure of the content and elaborate on the hierarchy as much as possible, expanding on each point.

2.  Structural Requirements:
    - Keep the structure clear for easy reading and parsing.
    - Use clear hierarchies with #, ##, ###, etc., for different levels.
    - Use the original language of the text for all nodes.
    - Present items in the content as lists.
    - The central topic should be around 10 words.
    - There should be a minimum of 3 levels, with no maximum limit.
    - If a level or branch contains too much text, split the content into same-level items or create deeper levels to keep the structure clean and concise.

3.  Content Handling:
    - Preserve the original sentences.
    - Do not add explanations or extra comments.
    - Do not add your own opinions or information outside the provided text.
    - Minor sentence adjustments for clarity are acceptable.
    - Long or complex sentences can be broken down into bullet points.

4.  Enhance Visibility:
    - Use Emoji to improve readability where appropriate.

5.  Output Language:
    - If the main content of the original text is not Chinese, output all Markdown content in the language of the original text.

6.  Output Format:
    - The final output must be in pure Markdown format.
    - Output only the Markdown text itself.
    - Do not wrap the output in code blocks.`
    }
};

function setLanguage(lang) {
    if (!translations[lang]) return;

    const oldDefaultMarkdown = T('defaultMarkdown');
    const isShowingDefaultMarkdown = currentMarkdown === oldDefaultMarkdown;

    currentLanguage = lang;
    localStorage.setItem('ai-mindmap-language', lang);
    document.documentElement.lang = lang.split('-')[0];

    const t = translations[lang];

    document.querySelectorAll('[data-t]').forEach(el => {
        const key = el.dataset.t;
        if (t[key]) el.innerHTML = t[key];
    });
    
    document.querySelectorAll('[data-t-placeholder]').forEach(el => {
        const key = el.dataset.tPlaceholder;
        if (t[key]) el.placeholder = t[key];
    });

    document.querySelectorAll('[data-t-title]').forEach(el => {
        const key = el.dataset.tTitle;
        if (t[key]) el.title = t[key];
    });

    document.querySelectorAll('#lang-switcher .lang-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.lang === lang);
    });

    document.title = (lang === 'zh') ? 'AIæ€ç»´å¯¼å›¾ç”Ÿæˆå™¨ - Markmap' : 'AI Mind Map Generator - Markmap';

    if (isShowingDefaultMarkdown) {
        currentMarkdown = T('defaultMarkdown');
        updateMarkmap(currentMarkdown);
    }
    
    loadPrompt();

    handleFullScreenChange();
    updateAllButtonStates();
    if (aiResults.length > 0) {
        renderResultTabs();
        document.querySelectorAll('.result-tab-btn').forEach(btn => {
            btn.classList.toggle('active', parseInt(btn.dataset.index) === activeResultIndex);
        });
    }
}

function T(key, ...args) {
    const translation = translations[currentLanguage]?.[key];
    if (typeof translation === 'function') {
        return translation(...args);
    }
    return translation || key;
}
// === Language Switching End ===

const topicInput = document.getElementById('topic-input');
const contentDisplay = document.getElementById('content-display');
const showOriginalBtn = document.getElementById('show-original-btn');
const showMarkdownBtn = document.getElementById('show-markdown-btn');
const exportBtn = document.getElementById('export-btn');
const settingsModal = document.getElementById('settings-modal');
const versionSlider = document.getElementById('version-slider');
const versionCountDisplay = document.getElementById('version-count-display');
const generateBtn = document.getElementById('generate-btn');
const pasteGenerateBtn = document.getElementById('paste-generate-btn');
const promptModal = document.getElementById('prompt-modal');
const promptInput = document.getElementById('prompt-input');

const LAST_SUCCESSFUL_MODEL_KEY = 'ai-mindmap-last-successful-model';

const colorPalette = [
  '#3B82F6',
  '#16A34A',
  '#F97316',
  '#9333EA',
  '#E11D48',
  '#0891B2',
];

function getNodeColor(node) {
  if (node.depth === 0) return '#374151'; 
  const index = (node.depth - 1) % colorPalette.length;
  return colorPalette[index];
}

function openSettingsModal() { settingsModal.classList.remove('hidden'); }
function closeSettingsModal() { settingsModal.classList.add('hidden'); }
function saveAndCloseSettings() {
    autoCompleteApiUrl();
    saveConfig();
    closeSettingsModal();
    const apiUrl = document.getElementById('api-url').value.trim();
    const apiKey = document.getElementById('api-key').value.trim();
    if (apiUrl && apiKey) { queryAvailableModels(true); }
}

function openPromptModal() {
    promptInput.value = AI_PROMPT_TEMPLATE;
    promptModal.classList.remove('hidden');
}

function closePromptModal() {
    promptModal.classList.add('hidden');
}

function saveAndClosePrompt() {
    const newPrompt = promptInput.value.trim();

    if (newPrompt) {
        if (newPrompt.includes('{{CONTENT}}')) {
            AI_PROMPT_TEMPLATE = newPrompt;
        } else {
            AI_PROMPT_TEMPLATE = newPrompt + '\n\n"{{CONTENT}}"';
        }
        localStorage.setItem('ai-mindmap-prompt', AI_PROMPT_TEMPLATE);
    } else {
        AI_PROMPT_TEMPLATE = T('defaultPrompt');
        localStorage.removeItem('ai-mindmap-prompt');
    }

    closePromptModal();
}

function updateVersionCountDisplay() {
    const count = versionSlider.value;
    versionCountDisplay.textContent = count;
}

function waitForLibraries() {
    return new Promise((resolve, reject) => {
        const checkInterval = setInterval(() => {
            if (window.markmap && window.html2canvas) {
                clearInterval(checkInterval);
                resolve();
            }
        }, 100);
        setTimeout(() => {
            clearInterval(checkInterval);
            reject(new Error('æ ¸å¿ƒåº“åŠ è½½è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–åˆ·æ–°é¡µé¢ã€‚'));
        }, 10000);
    });
}
async function init() {
    try {
        await waitForLibraries();
        const { Transformer, Markmap } = window.markmap;
        transformer = new Transformer();
        const svg = document.querySelector('#mindmap');
        
        mm = Markmap.create(svg, { 
            duration: 500, nodeMinHeight: 16, spacingVertical: 5, spacingHorizontal: 80, autoFit: true, fitRatio: 0.95, color: getNodeColor,
        });
        
        document.getElementById('lang-switcher').addEventListener('click', (e) => {
            if (e.target.matches('.lang-btn')) {
                const lang = e.target.dataset.lang;
                setLanguage(lang);
            }
        });

        document.getElementById('api-url').addEventListener('blur', autoCompleteApiUrl);
        
        document.getElementById('model-select').addEventListener('change', handleModelChange);
        ['api-url', 'api-key', 'model-select', 'custom-model-input'].forEach(id => {
            document.getElementById(id).addEventListener('input', saveConfig);
        });

        contentDisplay.addEventListener('input', handleDisplayEdit);
        topicInput.addEventListener('focus', () => switchView('input'));
        
        topicInput.addEventListener('input', handleTopicInput);

        document.addEventListener('fullscreenchange', handleFullScreenChange);
        document.addEventListener('webkitfullscreenchange', handleFullScreenChange);
        document.addEventListener('mozfullscreenchange', handleFullScreenChange);
        document.addEventListener('MSFullscreenChange', handleFullScreenChange);

        document.querySelector('#settings-modal .modal-close-btn').addEventListener('click', closeSettingsModal);
        settingsModal.addEventListener('click', (e) => {
            if (e.target === settingsModal) { closeSettingsModal(); }
        });
        
        document.getElementById('prompt-settings-btn').addEventListener('click', openPromptModal);
        document.querySelector('#prompt-modal .modal-close-btn').addEventListener('click', closePromptModal);
        promptModal.addEventListener('click', (e) => {
            if (e.target === promptModal) { closePromptModal(); }
        });

        versionSlider.addEventListener('input', () => {
            updateVersionCountDisplay();
            saveConfig();
        });
        
        document.getElementById('toggle-api-key-visibility').addEventListener('click', function() {
            const apiKeyInput = document.getElementById('api-key');
            const isPassword = apiKeyInput.type === 'password';
            apiKeyInput.type = isPassword ? 'text' : 'password';
            this.textContent = isPassword ? 'ğŸ™ˆ' : 'ğŸ‘ï¸';
        });

        loadConfig();

        const savedLang = localStorage.getItem('ai-mindmap-language');
        const browserLang = navigator.language.split('-')[0];
        const initialLang = savedLang || (['zh', 'en'].includes(browserLang) ? browserLang : 'zh');
        setLanguage(initialLang);

        const apiUrl = document.getElementById('api-url').value.trim();
        const apiKey = document.getElementById('api-key').value.trim();
        if (apiUrl && apiKey) {
            queryAvailableModels(true); 
        }

        handleModelChange();
        clearContent();
        updateVersionCountDisplay();

    } catch (error) {
        console.error('åˆå§‹åŒ–å¤±è´¥:', error);
        alert(error.message);
    }
}

function autoCompleteApiUrl() {
    const input = document.getElementById('api-url');
    let url = input.value.trim();
    if (!url || url.includes('/chat/completions')) { return; }
    url = url.replace(/\/+$/, '');
    let correctedUrl;
    if (url.endsWith('/v1')) {
        correctedUrl = url + '/chat/completions';
    } else {
        correctedUrl = url + '/v1/chat/completions';
    }
    input.value = correctedUrl;
}

function saveConfig() {
    const config = {
        apiUrl: document.getElementById('api-url').value,
        apiKey: document.getElementById('api-key').value,
        model: document.getElementById('model-select').value,
        customModel: document.getElementById('custom-model-input').value,
        versionCount: document.getElementById('version-slider').value,
    };
    localStorage.setItem('ai-mindmap-config', JSON.stringify(config));
}

function loadConfig() {
    try {
        const configStr = localStorage.getItem('ai-mindmap-config');
        const parsed = configStr ? JSON.parse(configStr) : {};

        document.getElementById('api-url').value = parsed.apiUrl || '';
        document.getElementById('api-key').value = parsed.apiKey || '';

        if (parsed.versionCount) {
            document.getElementById('version-slider').value = parsed.versionCount;
        }

        const modelSelect = document.getElementById('model-select');
        const customModelInput = document.getElementById('custom-model-input');
        
        let modelToSet;

        const lastSuccessfulModel = localStorage.getItem(LAST_SUCCESSFUL_MODEL_KEY);
        if (lastSuccessfulModel) {
            modelToSet = lastSuccessfulModel;
        } else {
            modelToSet = parsed.model || 'gpt-4o-mini';
        }
        
        if ([...modelSelect.options].some(opt => opt.value === modelToSet)) {
            modelSelect.value = modelToSet;
            customModelInput.value = parsed.customModel || '';
        } else {
            modelSelect.value = 'custom';
            customModelInput.value = modelToSet;
        }

    } catch(e) {
        console.error("è§£ææœ¬åœ°é…ç½®å¤±è´¥", e);
        localStorage.removeItem('ai-mindmap-config');
    }
}

function loadPrompt() {
    const savedPrompt = localStorage.getItem('ai-mindmap-prompt');
    AI_PROMPT_TEMPLATE = savedPrompt || T('defaultPrompt');
}

function handleModelChange() {
    const modelSelect = document.getElementById('model-select');
    const customModelInput = document.getElementById('custom-model-input');
    customModelInput.classList.toggle('hidden', modelSelect.value !== 'custom');
}

async function pasteAndGenerate() {
    if (!navigator.clipboard) {
        alert(T('js_alert_no_clipboard'));
        return;
    }

    try {
        const text = await navigator.clipboard.readText();
        if (!text.trim()) {
            alert(T('js_alert_clipboard_empty'));
            return;
        }
        
        topicInput.value = text;
        switchView('input');
        await generateWithAI();

    } catch (err) {
        console.error("æ— æ³•è¯»å–å‰ªè´´æ¿:", err);
        alert(T('js_alert_clipboard_error'));
    }
}

async function queryAvailableModels(isSilent = false) {
    const apiUrl = document.getElementById('api-url').value.trim();
    const apiKey = document.getElementById('api-key').value.trim();
    if (!apiUrl || !apiKey) {
        if (!isSilent) {
            alert(T('js_alert_query_no_config'));
            openSettingsModal();
        }
        return;
    }
    
    const queryBtn = document.getElementById('query-models-btn');
    const originalText = queryBtn.innerHTML;
    queryBtn.disabled = true;
    if (!isSilent) { queryBtn.innerHTML = T('js_querying'); }
    
    try {
        let modelsApiUrl = apiUrl.replace(/\/chat\/completions$/, '/models');
        if (!modelsApiUrl.endsWith('/models')) {
            const baseUrlMatch = apiUrl.match(/^(https?:\/\/.+?\/v\d+)/);
            if (baseUrlMatch) { modelsApiUrl = `${baseUrlMatch[1]}/models`;
            } else { throw new Error("æ— æ³•ä»APIåœ°å€æ¨æ–­å‡º/modelsè·¯å¾„ï¼Œè¯·æ£€æŸ¥APIåœ°å€æ ¼å¼ã€‚"); }
        }
        
        const response = await fetch(modelsApiUrl, {
            method: 'GET', headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' }
        });
        
        if (!response.ok) { 
            const errorText = await response.text();
            throw new Error(`æŸ¥è¯¢å¤±è´¥: ${response.status} - ${response.statusText}. å“åº”: ${errorText}`); 
        }
        
        const data = await response.json();
        const models = (data.data || data.models || []).map(m => m.id || m.name || m).filter(Boolean);
        if (models.length === 0) { throw new Error('æœªæ‰¾åˆ°å¯ç”¨æ¨¡å‹'); }
        
        const modelSelect = document.getElementById('model-select');
        const currentSelectedValue = modelSelect.value === 'custom' ? document.getElementById('custom-model-input').value : modelSelect.value;
        modelSelect.innerHTML = '<option value="custom">è‡ªå®šä¹‰</option>';
        models.forEach(modelId => {
            const option = document.createElement('option');
            option.value = option.textContent = modelId;
            modelSelect.appendChild(option);
        });
        
        const optionExists = models.includes(currentSelectedValue);
        if(optionExists) { modelSelect.value = currentSelectedValue;
        } else {
            modelSelect.value = 'custom';
            document.getElementById('custom-model-input').value = currentSelectedValue;
        }
        
        handleModelChange();
        saveConfig();
        
        if (!isSilent) {
            alert(T('js_alert_query_success', models.length));
        } else {
            console.log(`[Silent Query] Successfully fetched ${models.length} models.`);
        }
    } catch (error) {
        console.error('æŸ¥è¯¢æ¨¡å‹å¤±è´¥:', error);
        if (!isSilent) alert(T('js_alert_query_failed', error.message));
    } finally {
        queryBtn.disabled = false;
        queryBtn.innerHTML = T('queryBtn');
    }
}

async function generateWithAI() {
    const content = topicInput.value.trim();
    if (!content) { alert(T('js_alert_no_content')); return; }

    const apiUrl = document.getElementById('api-url').value.trim();
    const apiKey = document.getElementById('api-key').value.trim();
    const modelSelect = document.getElementById('model-select');
    let model = modelSelect.value === 'custom' ? document.getElementById('custom-model-input').value.trim() : modelSelect.value;
    
    if (modelSelect.value === 'custom' && !model) { alert(T('js_alert_no_custom_model')); return; }
    if (!apiUrl || !apiKey) { alert(T('js_alert_no_api_config')); openSettingsModal(); return; }

    const loadingOverlay = document.getElementById('loading-overlay');
    const statusMessage = document.getElementById('status-message');
    const timerDisplay = document.getElementById('timer-display');
    const generatingText = T('js_generating');

    generateBtn.disabled = true;
    pasteGenerateBtn.disabled = true;
    generateBtn.innerHTML = generatingText;
    pasteGenerateBtn.innerHTML = generatingText;

    loadingOverlay.style.display = 'flex';
    statusMessage.textContent = T('js_status_requesting');
    startTimer(timerDisplay);
    clearAiResults();

    try {
        const fetchPromises = [];
        const numVersions = parseInt(versionSlider.value, 10);
        for (let i = 0; i < numVersions; i++) {
            fetchPromises.push(
                fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                    body: JSON.stringify({
                        model: model,
                        messages: [{ role: 'user', content: AI_PROMPT_TEMPLATE.replace('{{CONTENT}}', content) }],
                        max_tokens: 2000,
                        temperature: 0.6 + i * 0.15
                    })
                })
            );
        }

        const responses = await Promise.allSettled(fetchPromises);
        let successfulResults = 0;

        for (const result of responses) {
            if (result.status === 'fulfilled') {
                const response = result.value;
                 if (response.ok) {
                    try {
                        const data = await response.json();
                        const markdownContent = data.choices?.[0]?.message?.content;
                        if (markdownContent) {
                            const { root } = transformer.transform(markdownContent.trim());
                            aiResults.push({ markdown: markdownContent.trim(), root: root });
                            successfulResults++;
                            statusMessage.textContent = T('js_status_generated', successfulResults, numVersions);
                        }
                    } catch (e) { console.error('è§£æAIå“åº”å¤±è´¥:', e); }
                }
            } else {
                console.error('ä¸€ä¸ªAIè¯·æ±‚å¤±è´¥:', result.reason);
            }
        }
        
        if (aiResults.length > 0) {
            localStorage.setItem(LAST_SUCCESSFUL_MODEL_KEY, model);
            statusMessage.textContent = T('js_status_done', aiResults.length);
            renderResultTabs();
            switchToResult(0);
            switchView('markdown');
            setTimeout(() => { loadingOverlay.style.display = 'none'; }, 1000);
        } else {
            throw new Error(T('js_alert_all_failed'));
        }

    } catch (error) {
        console.error('AIç”Ÿæˆå¤±è´¥:', error);
        alert(T('js_alert_gen_failed', error.message));
        loadingOverlay.style.display = 'none';
        updateMarkmap(currentMarkdown);
    } finally {
        stopTimer();
        generateBtn.disabled = false;
        pasteGenerateBtn.disabled = false;
        generateBtn.innerHTML = T('generateBtn');
        pasteGenerateBtn.innerHTML = T('pasteGenerateBtn');
        updateAllButtonStates();
    }
}

function handleTopicInput() {
    const text = this.value;
    if (text.trim().startsWith('#')) {
        clearAiResults();
        currentMarkdown = text;
        debounceUpdate(currentMarkdown);
    } else {
        updateAllButtonStates();
    }
}

function handleDisplayEdit() {
    if (currentViewMode === 'markdown') {
        const newMarkdown = this.value;
        currentMarkdown = newMarkdown;

        if (activeResultIndex > -1 && aiResults[activeResultIndex]) {
            aiResults[activeResultIndex].markdown = newMarkdown;
            try {
                const { root } = transformer.transform(newMarkdown);
                aiResults[activeResultIndex].root = root;
            } catch (error) {
                console.error('Error parsing edited markdown:', error);
            }
        }
        
        debounceUpdate(newMarkdown);
    } else if (currentViewMode === 'original') {
        topicInput.value = this.value;
        updateAllButtonStates();
    }
}

function switchView(viewName) {
    currentViewMode = viewName;
    if (viewName === 'original') {
        contentDisplay.value = topicInput.value;
        contentDisplay.style.display = 'block';
        topicInput.style.display = 'none';
    } else if (viewName === 'markdown') {
        contentDisplay.value = currentMarkdown;
        contentDisplay.style.display = 'block';
        topicInput.style.display = 'none';
    } else {
        contentDisplay.style.display = 'none';
        topicInput.style.display = 'block';
    }
    updateAllButtonStates();
}

function clearContent() {
    topicInput.value = '';
    clearAiResults();
    currentMarkdown = T('defaultMarkdown');
    updateMarkmap(currentMarkdown);
    switchView('input');
    topicInput.focus();
}

function clearAiResults() {
    aiResults = [];
    activeResultIndex = -1;
    renderResultTabs();
}

function renderResultTabs() {
    const tabsContainer = document.getElementById('results-tabs');
    tabsContainer.innerHTML = '';
    if (aiResults.length > 1) {
        aiResults.forEach((_, index) => {
            const tab = document.createElement('button');
            tab.className = 'result-tab-btn';
            tab.textContent = T('js_tab_version', index);
            tab.dataset.index = index;
            tab.onclick = () => switchToResult(index);
            tabsContainer.appendChild(tab);
        });
    }
}

function switchToResult(index) {
    if (index < 0 || index >= aiResults.length) return;

    activeResultIndex = index;
    const result = aiResults[index];
    currentMarkdown = result.markdown;
    mm.setData(result.root);
    mm.fit();

    if (currentViewMode === 'markdown') {
        contentDisplay.value = currentMarkdown;
    }

    document.querySelectorAll('.result-tab-btn').forEach(btn => {
        btn.classList.toggle('active', parseInt(btn.dataset.index) === index);
    });
}

function updateAllButtonStates() {
    const hasOriginalContent = topicInput.value.trim() !== '';
    const hasManualMd = topicInput.value.trim().startsWith('#');
    const hasGeneratedMd = aiResults.length > 0;
    const isDefaultMd = !hasManualMd && !hasGeneratedMd && currentMarkdown === T('defaultMarkdown');


    showOriginalBtn.classList.toggle('active', currentViewMode === 'original');
    showMarkdownBtn.classList.toggle('active', currentViewMode === 'markdown');
    showOriginalBtn.disabled = !hasOriginalContent;
    showMarkdownBtn.disabled = !hasGeneratedMd && !hasManualMd;
    exportBtn.disabled = isDefaultMd;
}

function updateMarkmap(markdown) {
    if (!mm || !transformer) return;
    try {
        const { root } = transformer.transform(markdown);
        mm.setData(root);
    } catch (error) { console.error('æ¸²æŸ“Markmapå¤±è´¥:', error); }
    updateAllButtonStates();
}

function debounceUpdate(markdown) {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => { updateMarkmap(markdown); mm.fit(); }, 300);
}

function startTimer(displayElement) {
    startTime = Date.now();
    displayElement.textContent = '0.0s';
    clearInterval(timerInterval);
    timerInterval = setInterval(() => {
        const elapsedSeconds = (Date.now() - startTime) / 1000;
        displayElement.textContent = `${elapsedSeconds.toFixed(1)}s`;
    }, 100);
}

function stopTimer() { clearInterval(timerInterval); }

function toggleFullScreen() {
    const mindmapPanel = document.querySelector('.mindmap-panel');
    const isFullScreen = document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement;

    if (!isFullScreen) {
        if (mindmapPanel.requestFullscreen) { mindmapPanel.requestFullscreen(); }
        else if (mindmapPanel.mozRequestFullScreen) { mindmapPanel.mozRequestFullScreen(); }
        else if (mindmapPanel.webkitRequestFullscreen) { mindmapPanel.webkitRequestFullscreen(); }
        else if (mindmapPanel.msRequestFullscreen) { mindmapPanel.msRequestFullscreen(); }
    } else {
        if (document.exitFullscreen) { document.exitFullscreen(); }
        else if (document.mozCancelFullScreen) { document.mozCancelFullScreen(); }
        else if (document.webkitExitFullscreen) { document.webkitExitFullscreen(); }
        else if (document.msExitFullscreen) { document.msExitFullscreen(); }
    }
}

function handleFullScreenChange() {
    const fullscreenBtn = document.getElementById('fullscreen-btn');
    const isFullScreen = document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement;
    
    fullscreenBtn.textContent = isFullScreen ? T('js_exit_fullscreen') : T('js_fullscreen');

    if (mm) {
        setTimeout(() => { mm.fit(); }, 200);
    }
}

async function exportPNG() {
    if (exportBtn.disabled) return;
    
    const mindmapSVG = document.querySelector('#mindmap-container svg');
    if (!mindmapSVG) { alert(T('js_alert_no_mindmap')); return; }
    
    const originalText = exportBtn.innerHTML;
    exportBtn.disabled = true;
    exportBtn.innerHTML = T('js_exporting');

    try {
        await mm.fit();
        const canvas = await html2canvas(mindmapSVG.parentElement, {
            backgroundColor: '#ffffff', logging: false, useCORS: true, scale: 2
        });
        const link = document.createElement('a');
        link.download = `ai-mindmap-${Date.now()}.png`;
        link.href = canvas.toDataURL('image/png');
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    } catch (error) {
        console.error('å¯¼å‡ºPNGå¤±è´¥:', error);
        alert(T('js_alert_export_error'));
    } finally {
        exportBtn.disabled = false;
        exportBtn.innerHTML = originalText;
    }
}

document.addEventListener('keydown', (e) => {
    if (e.key === 'F11') {
        e.preventDefault(); 
        toggleFullScreen();
    }

    const activeEl = document.activeElement;
    const isEditing = activeEl && (activeEl.tagName === 'INPUT' || activeEl.tagName === 'TEXTAREA');

    if (!isEditing && aiResults.length > 1) {
        let newIndex;
        if (e.key === 'ArrowRight') {
            e.preventDefault();
            newIndex = (activeResultIndex + 1) % aiResults.length;
            switchToResult(newIndex);
        } else if (e.key === 'ArrowLeft') {
            e.preventDefault();
            newIndex = (activeResultIndex - 1 + aiResults.length) % aiResults.length;
            switchToResult(newIndex);
        }
    }

    if ((e.ctrlKey || e.metaKey) && !e.shiftKey && !e.altKey) {
        if (e.key === 's') { 
            e.preventDefault(); 
            exportPNG(); 
        }
        if (e.key === 'Enter') { 
            if (document.activeElement === topicInput && topicInput.value.trim()){
                 e.preventDefault(); 
                 generateWithAI();
            }
        }
    }
});

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
